#!/usr/bin/perl

use strict;
use warnings;
use Time::HiRes;

my $hw = `uname -m`;
chomp($hw);

my $SHA256 = `ftp -o - http://ftp.openbsd.org/pub/OpenBSD/snapshots/$hw/SHA256`;

my $r; #r is for release

if ( $SHA256 =~ /base([0-9]{2,2}).tgz/ ) {
	$r = $1;
} else {
	print "No good SHA256 from http://ftp.OpenBSD.org. Aborting.\n";
	exit(1);
}
my @sets = ( "INSTALL.$hw",
	     "bsd",
	     "bsd.mp",
	     "bsd.rd",
	     "base$r.tgz",
	     "comp$r.tgz",
	     "etc$r.tgz",
	     "game$r.tgz",
	     "man$r.tgz",
	     "misc$r.tgz",
	     "xbase$r.tgz",
	     "xetc$r.tgz",
	     "xfont$r.tgz",
	     "xserv$r.tgz",
	     "xshare$r.tgz");

my @ftp_html = split /\n/, `ftp -o - http://www.openbsd.org/ftp.html`; 

my @servers;

my @synced_server;

for (@ftp_html) {
	if (/^\s+((http:|ftp:)\/\/.+)</ && (! /ftp\.OpenBSD\.org/)) {
		push @servers, $1;
	}
}

my $best_time;

for (@servers) {
	my $url = "${_}snapshots/$hw/SHA256";
	s!pub/OpenBSD/!!;
	my $time_before_dl = Time::HiRes::gettimeofday();
	my $mirrored_SHA256 = `ftp -o - $url 2>/dev/null`;
	my $time_after_dl = Time::HiRes::gettimeofday();
	my $time_diff = $time_after_dl - $time_before_dl;
	my $server = "";
	print "$time_diff:";
	if ($SHA256 eq $mirrored_SHA256) {
		if (! $best_time) {
			$best_time = $time_diff;
			printf "%20s, synced \n", $_ ;
			$server = $_;
		} elsif ( $time_diff < $best_time ) {
			printf "%20s, synced, seems faster\n", $_;
			$best_time = $time_diff;
			$server = $_;
		} else {
			printf "%20s, synced, doesn't seem faster\n", $_;
		}
	} else {
		printf "%20s, not synced\n", $_;
	}
}


print "$server seemed to be the fastest, let's get the sets!\n";

my $striped_SHA256 = "";

for(@sets) {
	print "getting $_...\n";
	`ftp $server/pub/OpenBSD/snapshots/$hw/$_`;
	$SHA256 =~ /(SHA256 \($_\) = [a-f0-9]+\n)/s;
	$striped_SHA256 .= $1;
}

open my $fh_SHA256, '>', 'SHA256';
print $fh_SHA256, $striped_SHA256;

`cksum -a sha256 -c SHA256`
